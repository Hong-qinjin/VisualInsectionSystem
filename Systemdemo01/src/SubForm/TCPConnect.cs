using System;using System.Collections.Generic;using System.IO;using System.Linq;using System.Net;using System.Net.Sockets;using System.Text;using System.Threading;using System.Windows.Forms;using Systemdemo01;namespace VisualInsectionSystem.SubForms{    /// <summary>    /// tcp_connect    /// </summary>    public partial class TCPConnect : Form    {        private Form1 mainForm;                 //ä¸»ç•Œé¢åº”ç”¨update_1117        // ç½‘ç»œé€šä¿¡ç›¸å…³å˜é‡        private TcpListener tcpServer;          // TCPæœåŠ¡ç«?        private TcpClient tcpClient;            // TCPå®¢æˆ·ç«?        private TcpClient currentClient;        // å½“å‰è¿æ¥çš„å®¢æˆ·ç«¯        private string currentClientInfo;        private UdpClient udpServer;        private UdpClient udpClient;        private NetworkStream stream;        private Thread listenThread;            // ç›‘å¬çº¿ç¨‹        private Thread receiveThread;           // æ¥æ”¶çº¿ç¨‹        private bool isListening = false;        private bool isConnected = false;        private bool isSending = false;        private string currentProtocol = "";    // å½“å‰é€‰æ‹©çš„åè®®ç±»å?        private Dictionary<string, TcpClient> connectedClients = new Dictionary<string, TcpClient>();   // å­˜å‚¨å·²è¿æ¥çš„å®¢æˆ·ç«?        private bool isHexSend = false;     // æ˜¯å¦16è¿›åˆ¶å‘é€?        private bool isHexReceive = false;        private int repeatInterval = 1000;      // é»˜è®¤é‡å¤å‘é€é—´éš?ç§?             /// <summary>        /// æ·»åŠ æ„é€ å‡½æ•°é‡è½½ï¼Œæ¥æ”¶ä¸»çª—ä½“å¼•ç”¨update_1117        /// </summary>        /// <param name="form"></param>        public TCPConnect(Form1 form)        {            mainForm = form;    //            InitializeComponent();            InitControls();            GetLocalIPAddress();            // åè®®å˜åŒ–äº‹ä»¶            comboBox1.SelectedIndexChanged += (s, e) =>            {                currentProtocol = comboBox1.SelectedItem.ToString();            };            // åˆå§‹åŒ–é»˜è®¤TCPæœåŠ¡å™¨ç«¯                        comboBox1.SelectedItem = "TCPæœåŠ¡ç«?;            UpdateControlStates();        }        // åè®®é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æ§ä»¶çŠ¶æ€?        private void ComboBox1_SelectedIndexChanged(object sender, EventArgs e)        {            UpdateControlStates();        }        // æ›´æ–°æ§ä»¶çŠ¶æ€?        private void UpdateControlStates()        {            //currentProtocol = "TCPæœåŠ¡ç«?;            string protocol = comboBox1.SelectedItem.ToString();            bool isTcpServer = protocol == "TCPæœåŠ¡ç«?;            //TCPæœåŠ¡ç«¯æ¨¡å¼ä¸‹,ä¸éœ€è¦ç›®æ ‡IPå’Œç«¯å?            comboBox3.Enabled = !isTcpServer;            textBox2.Enabled = !isTcpServer;            if (isTcpServer)            {                button1.Text = isListening ? "åœæ­¢ç›‘å¬" : "å¼€å§‹ç›‘å?;            }            else            {                button1.Text = isConnected ? "æ–­å¼€" : "è¿æ¥";            }        }        private void InitControls()        {            // åˆå§‹åŒ–åè®®ç±»å‹ä¸‹æ‹‰æ¡†            comboBox1.Items.AddRange(new string[] { "TCPæœåŠ¡ç«?, "TCPå®¢æˆ·ç«?, "UDPæœåŠ¡ç«?, "UDPå®¢æˆ·ç«? });            comboBox1.SelectedIndex = 0;            // è·å–æœ¬æœºIPåœ°å€å¹¶æ˜¾ç¤?            comboBox2.Text = GetLocalIPAddress();            // è®¾ç½®é»˜è®¤ç«¯å£å?            textBox1.Text = "8888";            textBox2.Text = "8888";            comboBox3.Text = "127.0.0.1";            // è®¾ç½®å•é€‰æŒ‰é’®æ–‡æœ?            radioButton1.Text = "16è¿›åˆ¶æ¥æ”¶";            radioButton2.Text = "16è¿›åˆ¶å‘é€?;            // æ·»åŠ å³é”®èœå•ç”¨äºä¿å­˜æ¶ˆæ¯            var contextMenu = new ContextMenuStrip();            contextMenu.Items.Add("ä¿å­˜æ¥æ”¶ä¿¡æ¯", null, SaveReceivedMessages);            listBox1.ContextMenuStrip = contextMenu;        }        // è·å–æœ¬æœºæ‰€æœ‰IPåœ°å€        private string GetLocalIPAddress()        {            foreach (IPAddress ip in Dns.GetHostAddresses(Dns.GetHostName()))            {                if (ip.AddressFamily == AddressFamily.InterNetwork)  //ip4                {                    comboBox2.Items.Add(ip.ToString());                    return ip.ToString();                }                //if (ip.AddressFamily == AddressFamily.InterNetworkV6)  //ip6                //{                //    comboBox2.Items.Add(ip.ToString());                //}                if (comboBox2.Items.Count > 0)                {                    comboBox2.SelectedIndex = 0;                }            }            return "127.0.0.1";        }        // ç›‘å¬/åœæ­¢æŒ‰é’®"å®¢æˆ·ç«¯è¿æ?        private void Button1_Click(object sender, EventArgs e)        {            currentProtocol = comboBox1.SelectedItem.ToString();    // è·å–å½“å‰é€‰æ‹©çš„åè®®ç±»å?            if (currentProtocol == "TCPæœåŠ¡ç«?)            {                if (!isListening)                {                    StartTcpServer();                }                else                {                    StopTcpServer();                }            }        }        //å¯åŠ¨TCPæœåŠ¡ç«?        private void StartTcpServer()        {            try            {                //è·å–åˆ°çš„æœ¬æœºIPå’Œportï¼Œä½œä¸ºæœåŠ¡å™¨                if (!ValidateIPAddress(comboBox2.Text))                {                    MessageBox.Show("æœ¬åœ°IPåœ°å€æ— æ•ˆ");                }                if (!ValidatePort(textBox1.Text, out int port))                {                    MessageBox.Show("ç«¯å£å·æ— æ•?);                    return;                }                //IPAddress localAddr = IPAddress.Any;    // ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å?                IPAddress localAddr = IPAddress.Parse(comboBox2.Text);  // æœ¬åœ°IPåœ°å€                port = int.Parse(textBox1.Text);    // æœ¬åœ°ç«¯å£å?                tcpServer = new TcpListener(localAddr, port);  // åˆ›å»ºTCPæœåŠ¡ç«?                tcpServer.Start();                isListening = true;                button1.Text = "åœæ­¢ç›‘å¬";                AddMessage($"TCPæœåŠ¡ç«¯å·²å¯åŠ¨ï¼Œç›‘å?{localAddr}:{port}ï¼Œç­‰å¾…è¿æ?..");                //å¯åŠ¨ç›‘å¬çº¿ç¨‹                listenThread = new Thread(ListenForClients);                listenThread.IsBackground = true;                listenThread.Start();            }            catch (Exception ex)            {                MessageBox.Show($"å¯åŠ¨TCPæœåŠ¡ç«¯å¤±è´? {ex.Message}");            }        }        //åœæ­¢å®¢æˆ·ç«?add:å½“å¤–éƒ¨å®¢æˆ·ç«¯æ–­å¼€æ—?        private void StopTcpServer()        {            isListening = false;            isConnected = false;            try            {                if (tcpServer != null)                {                    tcpServer.Stop();                }                //å…³é—­æ‰€æœ‰å·²è¿æ¥å®¢æˆ·ç«?                foreach (var client in connectedClients.Values)                {                    client.Close();                }                connectedClients.Clear();                currentClient = null;                currentClientInfo = "";                //                if (listenThread != null && listenThread.IsAlive)                {                    listenThread.Abort();                }                //                if (receiveThread != null && receiveThread.IsAlive)                {                    receiveThread.Abort();                }                button1.Text = "å¼€å§‹ç›‘å?;                AddMessage("TCPæœåŠ¡ç«¯å·²åœæ­¢");            }            catch (Exception ex)            {                MessageBox.Show($"åœæ­¢TCPæœåŠ¡ç«¯é”™è¯? {ex.Message}");            }        }        //ç›‘å¬clientè¿æ¥,add æŒç»­ç›‘å¬        private void ListenForClients()        {            try            {                while (isListening)                {                    //ç­‰å¾…å®¢æˆ·ç«¯è¿æ?                    TcpClient client = tcpServer.AcceptTcpClient();                    //æˆåŠŸè·å–åˆ°clientæ¶ˆæ¯ï¼ˆè¿œç¨‹ç«¯ç‚¹ä¿¡æ¯ï¼ŒIPå’Œportï¼?                    IPEndPoint clientEndPoint = (IPEndPoint)client.Client.RemoteEndPoint;                    //è½¬æ¢æ ¼å¼åŒ–æ˜¾ç¤?                    //string clientIP = clientEndPoint.Address.ToString();                    //string clientPort = clientEndPoint.Port.ToString();                    string clientEndPointInfoStr = $"{clientEndPoint.AddressFamily}:{clientEndPoint.Port}";                    clientEndPointInfoStr.ToString();                    //ä¿å­˜å·²è¿æ¥å®¢æˆ·ç«¯                    lock (connectedClients)                    {                        connectedClients[clientEndPointInfoStr] = client;                        currentClient = client;                        currentClientInfo += clientEndPointInfoStr;                    }                    // æ›´æ–°UIæ˜¾ç¤º                    Invoke(new Action(() =>                    {                        AddMessage($"å®¢æˆ·ç«¯å·²è¿æ¥: {clientEndPointInfoStr}");                        // åªå°†è¿æ¥çš„å®¢æˆ·ç«¯è®¾ä¸ºæ´»åŠ¨è¿æ¥å®¢æˆ·ç«?                        if (tcpClient == null || !tcpClient.Connected)                        {                            tcpClient = client;                            stream = tcpClient.GetStream();                            isConnected = true;                            // å¯åŠ¨æ¥æ”¶çº¿ç¨‹                            if (receiveThread == null || !receiveThread.IsAlive)                            {                                receiveThread = new Thread(ReceiveData);                                receiveThread.IsBackground = true;                                receiveThread.Start();                            }                        }                    }));                    ////clientæ–­å¼€æ—¶ï¼Œé‡Šæ”¾ä¹‹å‰è¿æ¥çš„clientä¿¡å·ï¼ŒæŒç»­ç›‘å¬æ–°çš„clientè¿æ¥                }            }            catch (Exception ex)            {                if (isListening)                {                    Invoke(new Action(() => AddMessage($"ç›‘å¬é”™è¯¯: {ex.Message}")));                    // å‘ç”Ÿé”™è¯¯åï¼Œé‡æ–°å¯åŠ¨ç›‘å¬                    if (isListening)                    {                        Invoke(new Action(() => AddMessage("å°è¯•é‡æ–°å¯åŠ¨ç›‘å¬...")));                        Thread.Sleep(3000);                        ListenForClients();     //é€’å½’                    }                }            }        }        //æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®_add Process        private void ReceiveData()        {            try            {                // å¾ªç¯                while (isConnected && tcpClient != null && tcpClient.Connected)                {                    NetworkStream clientStream = tcpClient.GetStream();                    byte[] buffer = new byte[4096];                    int bytesRead = clientStream.Read(buffer, 0, buffer.Length);                    if (bytesRead > 0)                    {                        //è½¬æ¢æ¥æ”¶æ•°æ®                        byte[] data = new byte[bytesRead];                        Array.Copy(buffer, data, bytesRead);                        // è·å–å‘é€æ•°æ®çš„å®¢æˆ·ç«¯ä¿¡æ?                        IPEndPoint clientEndPoint = (IPEndPoint)tcpClient.Client.RemoteEndPoint;                        string clientInfo = $"{clientEndPoint.Address}:{clientEndPoint.Port}";                        // dataè½¬æ¢ä¸ºå­—ç¬¦ä¸²_update1117                        string receivedStr = Encoding.UTF8.GetString(data).Trim();                        //æ˜¾ç¤ºæ¥æ”¶çš„æ•°æ®åœ¨listBox1å†…ï¼Œ                        Invoke(new Action(() =>                        {                            AddMessage($"ä»?{clientInfo} æ”¶åˆ°: {GetDisplayText(data)}");                        }));                        //å¤„ç†æ¥æ”¶æŒ‡ä»¤å‡½æ•°                        ProcessCommand(receivedStr, clientEndPoint);                    }                    else if (bytesRead == 0)                    {                        // å¦‚æœå®¢æˆ·ç«¯æ–­å¼€è¿æ¥                        string clientInfo = GetClientInfo(tcpClient);                        Invoke(new Action(() => AddMessage($"å®¢æˆ·ç«?{clientInfo} å·²æ–­å¼€è¿æ¥!")));                        break;                    }                }            }            catch (Exception ex)            {                if (isConnected && tcpClient != null)                {                    string clientInfo = GetClientInfo(tcpClient);                    Invoke(new Action(() => AddMessage($"ä¸?{clientInfo} é€šä¿¡é”™è¯¯: {ex.Message}")));                }            }            finally            {                // æ¸…ç†è¿æ¥çš„ç¼“å­?                CleanupClientConnection(tcpClient);                // é‡æ–°ç­‰å¾…æ–°çš„å®¢æˆ·ç«¯è¿æ?                ConnectToNextClient();            }        }        // å¤„ç†æŒ‡ä»¤å‡½æ•°        private void ProcessCommand(string command, IPEndPoint clientInfo)        {            try            {                string result = "";                //åœ¨ä¸»çº¿ç¨‹æ‰§è¡ŒForm1çš„å¯¹åº”æ“ä½?                mainForm.Invoke(new Action(() =>                {                    switch (command)                    {                        case "A":                            AddMessage($"æ”¶åˆ°æŒ‡ä»¤ â€˜{command}â€™ï¼Œæ‰§è¡Œæµç¨‹ä¸€");                            result = mainForm.ExecuteProcedure("Flow1");                            break;                        case "B":                            AddMessage($"æ”¶åˆ°æŒ‡ä»¤ â€˜{command}â€™ï¼Œæ‰§è¡Œæµç¨‹äº?);                            result = mainForm.ExecuteProcedure("Flow2");                            break;                        case "C":                            AddMessage($"æ”¶åˆ°æŒ‡ä»¤ â€˜{command}â€™ï¼Œæ‰§è¡Œæµç¨‹ä¸?);                            result = mainForm.ExecuteProcedure("Flow3");                            break;                        case "START_CONTINUOUS":                            AddMessage($"æ”¶åˆ°æŒ‡ä»¤ â€˜{command}â€™ï¼Œå¯åŠ¨è¿ç»­æ‰§è¡Œ");                            mainForm.button4_Click(this, EventArgs.Empty);                            result = "è¿ç»­æ‰§è¡Œå·²å¯åŠ?;                            break;                        case "STOP_CONTINUOUS":                            AddMessage($"æ”¶åˆ°æŒ‡ä»¤ '{command}', åœæ­¢è¿ç»­æ‰§è¡Œ...");                            mainForm.button5_Click(this, EventArgs.Empty);                            result = "è¿ç»­æ‰§è¡Œå·²åœæ­?;                            break;                        default:                            AddMessage($"æœªçŸ¥æŒ‡ä»¤: {command}");                            result = $"æœªçŸ¥æŒ‡ä»¤: {command}";                            break;                    }                }));                //                SendResultToClient(result, clientInfo);            }            catch (Exception ex)            {                Invoke(new Action(() =>                {                    AddMessage($"å¤„ç†æŒ‡ä»¤é”™è¯¯: {ex.Message}");                }));                SendResultToClient($"å¤„ç†æŒ‡ä»¤é”™è¯¯: {ex.Message}", clientInfo);            }        }        // å‘é€ç»“æœåˆ°å®¢æˆ·ç«?        private void SendResultToClient(string result, IPEndPoint clientInfo)        {            try            {                byte[] data = Encoding.UTF8.GetBytes(result);                // å‘é€æ•°æ®åˆ°å½“å‰è¿æ¥åˆ°çš„å®¢æˆ·ç«?                if (tcpClient != null && tcpClient.Connected)                {                    NetworkStream clientStream = tcpClient.GetStream();                    clientStream.Write(data, 0, data.Length);                    clientStream.Flush();                    Invoke(new Action(() =>                    {                        AddMessage($"å‘é€ç»“æœåˆ° {clientInfo}: {result}");                    }));                }                else                {                    Invoke(new Action(() =>                    {                        AddMessage($"å‘é€ç»“æœåˆ° {clientInfo}: {result}");                    }));                }            }            catch (Exception ex)            {                Invoke(new Action(() =>                {                    AddMessage($"å‘é€ç»“æœå¤±è´? {ex.Message}");                }));            }        }        // å‘é€æ•°æ?        private void SendData()        {            if (string.IsNullOrEmpty(textBox5.Text))            {                MessageBox.Show("è¯·è¾“å…¥è¦å‘é€çš„æ•°æ®");                return;            }            //å‘é€textBox5å†…æ•°æ®ç»™è¿æ¥æˆåŠŸçš„tcpClient            try            {                byte[] data;                //æ ¹æ®è®¾ç½®è½¬æ¢å‘é€æ•°æ?                if (isHexSend)                {                    //16è¿›åˆ¶å‘é€?                    string hexString = textBox5.Text.Replace(" ", "");                    data = HexStringToByteArray(hexString);                }                else                {                    //å­—ç¬¦ä¸²å‘é€?                    data = Encoding.UTF8.GetBytes(textBox5.Text);                }                if (data.Length == 0)                {                    AddMessage("å‘é€æ•°æ®ä¸ºç©?);                    return;                }                // å‘é€æ•°æ®åˆ°å½“å‰è¿æ¥åˆ°çš„å®¢æˆ·ç«?é˜²æ­¢ä¸­æ–‡ä¹±ç                 if (tcpClient != null && tcpClient.Connected)                {                    NetworkStream clientStream = tcpClient.GetStream();                    clientStream.Write(data, 0, data.Length);                    clientStream.Flush();                    string clientInfo = GetClientInfo(tcpClient);                    AddMessage($"å‘é€åˆ° {clientInfo}: {GetDisplayText(data)}");                }                else                {                    AddMessage("å®¢æˆ·ç«¯å·²æ–­å¼€è¿æ¥ï¼Œæ— æ³•å‘é€æ•°æ?);                    isConnected = false;                    ConnectToNextClient();                }            }            catch (Exception ex)            {                MessageBox.Show($"å‘é€å¤±è´? {ex.Message}");            }        }        // è·å–å®¢æˆ·ç«¯ä¿¡æ¯å­—ç¬¦ä¸²        private string GetClientInfo(TcpClient client)        {            try            {                if (client != null && client.Client != null && client.Client.RemoteEndPoint != null)                {                    IPEndPoint endPoint = (IPEndPoint)client.Client.RemoteEndPoint;                    return $"{endPoint.Address}:{endPoint.Port}";                }                return "æœªçŸ¥å®¢æˆ·ç«?;            }            catch (Exception)            {                return "æœªçŸ¥å®¢æˆ·ç«?;            }        }        // æ¸…ç†æ–­å¼€è¿æ¥çš„å®¢æˆ·ç«¯ç¼“å­˜ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯é‡æ–°è¿æ¥        private void CleanupClientConnection(TcpClient client)        {            try            {                if (client != null)                {                    string clientInfo = GetClientInfo(client);                    lock (connectedClients)                    {                        if (connectedClients.ContainsKey(clientInfo))                        {                            connectedClients.Remove(clientInfo);                        }                    }                    client.Close();                }            }            catch (Exception ex)            {                Invoke(new Action(() => AddMessage($"æ¸…ç†å®¢æˆ·ç«¯è¿æ¥é”™è¯? {ex.Message}")));            }        }        // é‡æ–°ç­‰å¾…è¿æ¥ï¼Œç¡®ä¿æŒç»­ç›‘å¬æ–°çš„è¿æ?        private void ConnectToNextClient()        {            try            {                Invoke(new Action(() =>                {                    lock (connectedClients)                    {                        if (connectedClients.Count > 0)                        {                            // è·å–ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯                            var firstClient = connectedClients.First();                            tcpClient = firstClient.Value;                            //add if_1120                            if (tcpClient != null && tcpClient.Connected)                            {                                stream = tcpClient.GetStream();     //clientæ–­å¼€ï¼Œå¼‚å¸?                                isConnected = true;                                AddMessage($"å·²åˆ‡æ¢å®¢æˆ·ç«¯: {firstClient.Key}");                                // å¯åŠ¨æ¥æ”¶çº¿ç¨‹                                if (receiveThread == null || !receiveThread.IsAlive)                                {                                    receiveThread = new Thread(ReceiveData);                                    receiveThread.IsBackground = true;                                    receiveThread.Start();                                }                            }                            else                            {                                //è¿æ¥æ–­å¼€æ—?                                connectedClients.Remove(firstClient.Key);                                tcpClient = null;                                stream = null;                                isConnected = false;                                AddMessage("ç­‰å¾…æ–°è¿æ¥çš„å®¢æˆ·ç«?..");                            }                        }                        else                        {                            //æ— å®¢æˆ·ç«¯æ—?                            tcpClient = null;                            stream = null;                            isConnected = false;                            AddMessage("ç­‰å¾…æ–°è¿æ¥çš„å®¢æˆ·ç«?..");                            // å¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥ä½†éœ€è¦æŒç»­ç›‘å¬ï¼Œå¹¶é‡å?                            if (isListening && (listenThread == null || !listenThread.IsAlive))                            {                                listenThread = new Thread(ListenForClients);                                listenThread.IsBackground = true;                                listenThread.Start();                            }                        }                    }                }));            }            catch (Exception ex)            {                Invoke(new Action(() => AddMessage($"è¿æ¥åˆ°å®¢æˆ·ç«¯é”™è¯¯: {ex.Message}")));            }        }        // æ¸…ç©ºæ¶ˆæ¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶        private void Button2_Click(object sender, EventArgs e)        {            listBox1.Items.Clear();        }        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»?        private void Button3_Click(object sender, EventArgs e)        {            if (currentProtocol != "TCPæœåŠ¡ç«?)            {                MessageBox.Show("ä»…TCPæœåŠ¡ç«¯æ¨¡å¼ä¸‹å¯å‘é€æ•°æ?);                return;            }            if (!isListening)            {                MessageBox.Show("è¯·å…ˆå¯åŠ¨TCPæœåŠ¡ç«?);                return;            }            if (!isConnected || tcpClient == null || !tcpClient.Connected)            {                MessageBox.Show("è¯·å…ˆå»ºç«‹è¿æ¥,æ— æ³•å‘é€æ•°æ?);                return;            }            string message = textBox5.Text;            if (string.IsNullOrEmpty(message))                return;            SendData();        }        //æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡?        private void AddMessage(string message)        {            if (listBox1.InvokeRequired)            {                listBox1.Invoke(new Action<string>(AddMessage), message);                return;            }            string timeStamp = DateTime.Now.ToString("HH:mm:ss.fff");            listBox1.Items.Add($"[{timeStamp}] {message}");            listBox1.TopIndex = listBox1.Items.Count - 1; // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ?        }        // éªŒè¯IPåœ°å€        private bool ValidateIPAddress(string ipAddress)        {            return IPAddress.TryParse(ipAddress, out _);        }        // éªŒè¯ç«¯å£å?        private bool ValidatePort(string portText, out int port)        {            if (int.TryParse(portText, out port))            {                return port >= 1 && port <= 65535;            }            return false;        }        // 16è¿›åˆ¶å­—ç¬¦ä¸²è½¬å­—èŠ‚æ•°ç»„        private byte[] HexStringToByteArray(string hex)        {            if (string.IsNullOrEmpty(hex))                return new byte[0];            if (hex.Length % 2 != 0)            {                hex += "0";            }            byte[] bytes = new byte[hex.Length / 2];            for (int i = 0; i < hex.Length; i += 2)            {                bytes[i / 2] = Convert.ToByte(hex.Substring(i, 2), 16);            }            return bytes;        }        // å­—èŠ‚æ•°ç»„è½?6è¿›åˆ¶å­—ç¬¦ä¸?        private string ByteArrayToHexString(byte[] bytes)        {            StringBuilder sb = new StringBuilder();            foreach (byte b in bytes)            {                sb.AppendFormat("{0:X2} ", b);            }            return sb.ToString().Trim();        }        // æ ¹æ®è®¾ç½®è·å–æ˜¾ç¤ºæ–‡æœ¬        private string GetDisplayText(byte[] data)        {            if (isHexReceive)            {                return ByteArrayToHexString(data);            }            else            {                try                {                    return Encoding.UTF8.GetString(data);                }                catch                {                    return ByteArrayToHexString(data);                }            }        }        // ä¿å­˜æ¥æ”¶çš„æ¶ˆæ¯åˆ°æ–‡ä»¶        private void SaveReceivedMessages(object sender, EventArgs e)        {            if (listBox1.Items.Count == 0)            {                MessageBox.Show("æ²¡æœ‰æ¶ˆæ¯å¯ä¿å­?);                return;            }            SaveFileDialog saveFileDialog = new SaveFileDialog();            saveFileDialog.Filter = "æ–‡æœ¬æ–‡ä»¶ (*.txt)|*.txt|æ‰€æœ‰æ–‡ä»?(*.*)|*.*";            saveFileDialog.Title = "ä¿å­˜æ¥æ”¶çš„æ¶ˆæ?;            saveFileDialog.FileName = $"æ¶ˆæ¯è®°å½•_{DateTime.Now:yyyyMMddHHmmss}.txt";            if (saveFileDialog.ShowDialog() == DialogResult.OK)            {                try                {                    using (StreamWriter sw = new StreamWriter(saveFileDialog.FileName))                    {                        foreach (var item in listBox1.Items)                        {                            sw.WriteLine(item.ToString());                        }                    }                    MessageBox.Show("æ¶ˆæ¯å·²æˆåŠŸä¿å­?);                }                catch (Exception ex)                {                    MessageBox.Show($"ä¿å­˜å¤±è´¥: {ex.Message}");                }            }        }        // è¿æ¥ç½‘ç»œ        private bool Connect()        {            currentProtocol = comboBox1.SelectedItem.ToString();            int localPort = 8888;            try            {                switch (currentProtocol)                {                    case "TCPæœåŠ¡ç«?:                        tcpServer = new TcpListener(IPAddress.Parse(comboBox2.Text), localPort);                        tcpServer.Start();                        listenThread = new Thread(TcpServerListen);                        listenThread.IsBackground = true;                        listenThread.Start();                        AddMessage("TCPæœåŠ¡ç«¯å·²å¯åŠ¨ï¼Œç­‰å¾…è¿æ?..");                        return true;                    case "TCPå®¢æˆ·ç«?:                        if (!ValidateIPAddress(comboBox3.Text))                        {                            MessageBox.Show("ç›®æ ‡IPåœ°å€æ— æ•ˆ");                            return false;                        }                        if (!ValidatePort(textBox2.Text, out int remotePort))                        {                            MessageBox.Show("ç›®æ ‡ç«¯å£æ— æ•ˆ");                            return false;                        }                        tcpClient = new TcpClient();                        tcpClient.Connect(textBox2.Text, remotePort);                        listenThread = new Thread(TcpClientReceive);                        listenThread.IsBackground = true;                        listenThread.Start();                        AddMessage("TCPå®¢æˆ·ç«¯å·²è¿æ¥åˆ°æœåŠ¡å™¨");                        return true;                    case "UDPæœåŠ¡ç«?:                        udpServer = new UdpClient(localPort);                        listenThread = new Thread(UdpServerReceive);                        listenThread.IsBackground = true;                        listenThread.Start();                        AddMessage("UDPæœåŠ¡ç«¯å·²å¯åŠ¨");                        return true;                    case "UDPå®¢æˆ·ç«?:                        if (!ValidateIPAddress(comboBox2.Text))                        {                            MessageBox.Show("ç›®æ ‡IPåœ°å€æ— æ•ˆ");                            return false;                        }                        if (!ValidatePort(textBox2.Text, out remotePort))                        {                            MessageBox.Show("ç›®æ ‡ç«¯å£æ— æ•ˆ");                            return false;                        }                        udpClient = new UdpClient(localPort);                        listenThread = new Thread(() => UdpClientReceive(IPAddress.Parse(textBox2.Text), remotePort));                        listenThread.IsBackground = true;                        listenThread.Start();                        AddMessage("UDPå®¢æˆ·ç«¯å·²å¯åŠ¨");                        return true;                    default:                        return false;                }            }            catch (Exception ex)            {                AddMessage($"è¿æ¥å¤±è´¥: {ex.Message}");                return false;            }        }        // æ–­å¼€è¿æ¥        private void Disconnect()        {            isSending = false;            button3.Text = "å‘é€?;            try            {                switch (currentProtocol)                {                    case "TCPæœåŠ¡ç«?:                        if (tcpServer != null)                        {                            tcpServer.Stop();                        }                        break;                    case "TCPå®¢æˆ·ç«?:                        if (tcpClient != null)                        {                            tcpClient.Close();                        }                        break;                    case "UDPæœåŠ¡ç«?:                        if (udpServer != null)                        {                            udpServer.Close();                        }                        break;                    case "UDPå®¢æˆ·ç«?:                        if (udpClient != null)                        {                            udpClient.Close();                        }                        break;                }                if (listenThread != null && listenThread.IsAlive)                {                    listenThread.Abort();                }            }            catch (Exception ex)            {                AddMessage($"æ–­å¼€è¿æ¥é”™è¯¯: {ex.Message}");            }        }        // TCPæœåŠ¡ç«¯ç›‘å?        private void TcpServerListen()        {            try            {                while (isConnected)                {                    tcpClient = tcpServer.AcceptTcpClient();                    AddMessage("å®¢æˆ·ç«¯å·²è¿æ¥");                    // å¼€å§‹æ¥æ”¶æ•°æ?                    TcpClientReceive();                }            }            catch (Exception ex)            {                if (isConnected)                {                    AddMessage($"TCPæœåŠ¡ç«¯é”™è¯? {ex.Message}");                }            }        }        // TCPå®¢æˆ·ç«¯æ¥æ”¶æ•°æ?        private void TcpClientReceive()        {            try            {                if (tcpClient == null) return;                NetworkStream stream = tcpClient.GetStream();                byte[] buffer = new byte[1024];                int bytesRead;                while (isConnected && tcpClient.Connected)                {                    bytesRead = stream.Read(buffer, 0, buffer.Length);                    if (bytesRead > 0)                    {                        byte[] data = new byte[bytesRead];                        Array.Copy(buffer, data, bytesRead);                        AddMessage($"æ”¶åˆ°: {GetDisplayText(data)}");                    }                }            }            catch (Exception ex)            {                if (isConnected)                {                    AddMessage($"TCPæ¥æ”¶é”™è¯¯: {ex.Message}");                }            }        }        // UDPæœåŠ¡ç«¯æ¥æ”¶æ•°æ?        private void UdpServerReceive()        {            try            {                IPEndPoint remoteEndPoint = new IPEndPoint(IPAddress.Any, 0);                while (isConnected)                {                    byte[] data = udpServer.Receive(ref remoteEndPoint);                    // æ›´æ–°ç›®æ ‡IPå’Œç«¯å£ä¸ºå‘é€æ–¹çš„ä¿¡æ?                    textBox2.Text = remoteEndPoint.Address.ToString();                    textBox1.Text = remoteEndPoint.Port.ToString();                    AddMessage($"æ”¶åˆ°æ¥è‡ª {remoteEndPoint}: {GetDisplayText(data)}");                }            }            catch (Exception ex)            {                if (isConnected)                {                    AddMessage($"UDPæœåŠ¡ç«¯é”™è¯? {ex.Message}");                }            }        }        // UDPå®¢æˆ·ç«¯æ¥æ”¶æ•°æ?        private void UdpClientReceive(IPAddress remoteIp, int remotePort)        {            try            {                IPEndPoint remoteEndPoint = new IPEndPoint(remoteIp, remotePort);                while (isConnected)                {                    byte[] data = udpClient.Receive(ref remoteEndPoint);                    AddMessage($"æ”¶åˆ°æ¥è‡ª {remoteEndPoint}: {GetDisplayText(data)}");                }            }            catch (Exception ex)            {                if (isConnected)                {                    AddMessage($"UDPå®¢æˆ·ç«¯é”™è¯? {ex.Message}");                }            }        }        // 16è¿›åˆ¶æ¥æ”¶å•é€‰æŒ‰é’®äº‹ä»?        private void radioButton1_CheckedChanged(object sender, EventArgs e)        {            isHexReceive = radioButton1.Checked;        }        // 16è¿›åˆ¶å‘é€å•é€‰æŒ‰é’®äº‹ä»?        private void radioButton2_CheckedChanged(object sender, EventArgs e)        {            isHexSend = radioButton2.Checked;        }        private void TCPConnect_Load(object sender, EventArgs e)        {            // ç»‘å®šå•é€‰æŒ‰é’®äº‹ä»?            radioButton1.CheckedChanged += radioButton1_CheckedChanged;            radioButton2.CheckedChanged += radioButton2_CheckedChanged;        }        /// <summary>        /// çª—ä½“å…³é—­æ—¶ç¡®ä¿æ–­å¼€è¿æ¥        /// </summary>        /// <param name="e"></param>        protected override void OnFormClosing(FormClosingEventArgs e)        {            if (isConnected)            {                Disconnect();            }            base.OnFormClosing(e);        }    }}